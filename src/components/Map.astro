---
import { Image } from 'astro:assets';
import MapHotspots from './MapHotspots.astro';
import mapSrc from '../assets/map.png';
---

<div class="map-container">
	<div class="map-wrapper" id="map" transition:persist="map">
		<Image src={mapSrc} alt="Mappa Borgo Guglielmo" quality={80} format="webp" layout="full-width" />
		<MapHotspots />
	</div>
</div>

<script>
	import Panzoom from '@panzoom/panzoom';

	const initMap = () => {
		const map = document.getElementById('map') as HTMLElement & { _panzoom?: ReturnType<typeof Panzoom> };
		const img = map?.querySelector('img') as HTMLImageElement | null;

		if (!map || !img) return;
		if (map._panzoom) return;

		const setup = () => {
			const imgW = img.naturalWidth;
			const imgH = img.naturalHeight;
			const winW = window.innerWidth;
			const winH = window.innerHeight;

			const defaultScale = 2.5;
			const savedJson = sessionStorage.getItem('mapState');
			const saved = savedJson ? JSON.parse(savedJson) : null;
			const scale = saved?.scale ?? defaultScale;
			const startX = saved?.x ?? (winW - imgW * defaultScale) / 2;
			const startY = saved?.y ?? (winH - imgH * defaultScale) / 2;

			const panzoom = Panzoom(map, {
				maxScale: 10,
				minScale: 1.5,
				startScale: scale,
				startX,
				startY,
				contain: 'outside',
			});

			map._panzoom = panzoom;

			const saveState = () => {
				const pan = panzoom.getPan();
				sessionStorage.setItem('mapState', JSON.stringify({ x: pan.x, y: pan.y, scale: panzoom.getScale() }));
			};

			map.addEventListener('panzoomstart', () => {
				map.classList.add('is-dragging');
			});

			map.addEventListener('panzoomend', () => {
				map.classList.remove('is-dragging');
				saveState();
			});

			let targetScale = scale;
			let currentScale = scale;
			let isAnimating = false;

			const lerp = (start: number, end: number, t: number) => start + (end - start) * t;

			const animateZoom = () => {
				currentScale = lerp(currentScale, targetScale, 0.04);

				if (Math.abs(currentScale - targetScale) > 0.001) {
					panzoom.zoom(currentScale, { animate: false });
					requestAnimationFrame(animateZoom);
				} else {
					currentScale = targetScale;
					panzoom.zoom(targetScale, { animate: false });
					isAnimating = false;
					saveState();
				}
			};

			map.parentElement?.addEventListener('wheel', (e) => {
				e.preventDefault();
				const delta = e.deltaY > 0 ? 0.95 : 1.05;
				targetScale = Math.min(10, Math.max(1.5, targetScale * delta));

				if (!isAnimating) {
					isAnimating = true;
					requestAnimationFrame(animateZoom);
				}
			}, { passive: false });
		};

		if (img.complete) {
			setup();
		} else {
			img.onload = setup;
		}
	};

	document.addEventListener('astro:page-load', initMap);
</script>

<style is:global>
	.map-container {
		position: absolute;
		inset: 0;
	}

	.map-wrapper {
		width: 100%;
		height: 100%;
		cursor: default !important;
	}

	.map-wrapper.is-dragging {
		cursor: grabbing !important;
	}

	.map-wrapper img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		pointer-events: none;
		user-select: none;
	}
</style>
