---
import { Image } from 'astro:assets';
import MapHotspots from './MapHotspots.astro';
import mapSrc from '../assets/map.png';
---

<div class="map-container">
	<div class="map-wrapper" id="map" transition:persist="map">
		<Image src={mapSrc} alt="Mappa Borgo Guglielmo" quality={80} format="webp" layout="full-width" />
		<MapHotspots />
	</div>
</div>

<script>
	import Panzoom from '@panzoom/panzoom';

	interface MapElement extends HTMLElement {
		_panzoom?: ReturnType<typeof Panzoom>;
		_wheelParent?: HTMLElement;
		_zoomState?: { targetScale: number; currentScale: number; isAnimating: boolean };
	}

	const initMap = () => {
		const map = document.getElementById('map') as MapElement | null;
		const img = map?.querySelector('img') as HTMLImageElement | null;

		if (!map || !img) return;

		const setupWheel = (panzoom: ReturnType<typeof Panzoom>) => {
			const parent = map.parentElement;
			if (!parent || map._wheelParent === parent) return;

			map._zoomState = map._zoomState || {
				targetScale: panzoom.getScale(),
				currentScale: panzoom.getScale(),
				isAnimating: false
			};

			const state = map._zoomState;
			const lerp = (start: number, end: number, t: number) => start + (end - start) * t;

			const saveState = () => {
				const pan = panzoom.getPan();
				sessionStorage.setItem('mapState', JSON.stringify({ x: pan.x, y: pan.y, scale: panzoom.getScale() }));
			};

			const animateZoom = () => {
				state.currentScale = lerp(state.currentScale, state.targetScale, 0.04);

				if (Math.abs(state.currentScale - state.targetScale) > 0.001) {
					panzoom.zoom(state.currentScale, { animate: false });
					requestAnimationFrame(animateZoom);
				} else {
					state.currentScale = state.targetScale;
					panzoom.zoom(state.targetScale, { animate: false });
					state.isAnimating = false;
					saveState();
				}
			};

			parent.addEventListener('wheel', (e) => {
				e.preventDefault();
				const delta = e.deltaY > 0 ? 0.95 : 1.05;
				state.targetScale = Math.min(10, Math.max(1.5, state.targetScale * delta));

				if (!state.isAnimating) {
					state.isAnimating = true;
					requestAnimationFrame(animateZoom);
				}
			}, { passive: false });

			map._wheelParent = parent;
		};

		if (map._panzoom) {
			setupWheel(map._panzoom);
			return;
		}

		const setup = () => {
			const imgW = img.naturalWidth;
			const imgH = img.naturalHeight;
			const winW = window.innerWidth;
			const winH = window.innerHeight;

			const savedJson = sessionStorage.getItem('mapState');
			const saved = savedJson ? JSON.parse(savedJson) : null;
			const scale = saved?.scale ?? 1.95;
			const startX = saved?.x ?? -65;
			const startY = saved?.y ?? 70;

			const panzoom = Panzoom(map, {
				maxScale: 10,
				minScale: 1.5,
				startScale: scale,
				startX,
				startY,
				contain: 'outside',
			});

			map._panzoom = panzoom;

			const saveState = () => {
				const pan = panzoom.getPan();
				sessionStorage.setItem('mapState', JSON.stringify({ x: pan.x, y: pan.y, scale: panzoom.getScale() }));
			};

			map.addEventListener('panzoomstart', () => {
				map.classList.add('is-dragging');
			});

			map.addEventListener('panzoomend', () => {
				map.classList.remove('is-dragging');
				saveState();
			});

			setupWheel(panzoom);
		};

		if (img.complete) {
			setup();
		} else {
			img.onload = setup;
		}
	};

	document.addEventListener('astro:page-load', initMap);

	// Dev tool: Shift+P to log current map position and zoom
	document.addEventListener('keydown', (e) => {
		if (e.shiftKey && e.key === 'P') {
			const map = document.getElementById('map') as any;
			if (map?._panzoom) {
				const pan = map._panzoom.getPan();
				const scale = map._panzoom.getScale();
				console.log(`üìç Map position: x=${pan.x.toFixed(0)}, y=${pan.y.toFixed(0)}, scale=${scale.toFixed(2)}`);
			}
		}
	});

	// Dev tool: Shift+H to toggle hotspot edit mode
	let hotspotMode = false;
	let hotspotPoints: string[] = [];

	document.addEventListener('keydown', (e) => {
		if (e.shiftKey && e.key === 'H') {
			hotspotMode = !hotspotMode;
			hotspotPoints = [];
			console.log(hotspotMode ? 'üéØ Hotspot mode ON - click to add points, Shift+H to finish' : 'üéØ Hotspot mode OFF');
			document.body.style.cursor = hotspotMode ? 'crosshair' : '';
		}
	});

	document.addEventListener('click', (e) => {
		if (!hotspotMode) return;
		const map = document.getElementById('map');
		const img = map?.querySelector('img');
		if (!map || !img) return;

		const rect = img.getBoundingClientRect();
		const x = ((e.clientX - rect.left) / rect.width * 100).toFixed(1);
		const y = ((e.clientY - rect.top) / rect.height * 100).toFixed(1);

		hotspotPoints.push(`${x} ${y}`);
		console.log(`üìç Point ${hotspotPoints.length}: ${x} ${y}`);
		console.log('üìã All points:\n' + hotspotPoints.join('\n'));
	});
</script>

<style>
	.map-container {
		position: absolute;
		inset: 0;
	}

	.map-wrapper {
		width: 100%;
		height: 100%;
		cursor: default !important;
	}

	.map-wrapper:global(.is-dragging) {
		cursor: grabbing !important;
	}

	.map-wrapper img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		pointer-events: none;
		user-select: none;
	}
</style>
