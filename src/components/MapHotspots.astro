---
import { getCollection } from 'astro:content';

const immobili = await getCollection('immobili');
const hotspots = immobili.filter((i) => i.data.hotspot?.trim());

const parseHotspot = (text: string) => {
	return text.trim().split('\n').map(line => {
		const [x, y] = line.trim().split(/\s+/).map(Number);
		return `${x},${y}`;
	}).join(' ');
};
---

<svg class="hotspots" viewBox="0 0 100 100" preserveAspectRatio="none">
	<defs>
		<!-- Empty: light blue -->
		<linearGradient id="hotspot-empty" x1="0%" y1="0%" x2="0%" y2="100%">
			<stop offset="0%" stop-color="rgba(147, 197, 253, 0.5)" />
			<stop offset="100%" stop-color="rgba(147, 197, 253, 0.2)" />
		</linearGradient>
		<linearGradient id="hotspot-empty-hover" x1="0%" y1="0%" x2="0%" y2="100%">
			<stop offset="0%" stop-color="rgba(147, 197, 253, 0.7)" />
			<stop offset="100%" stop-color="rgba(147, 197, 253, 0.4)" />
		</linearGradient>
		<!-- In Construction: medium blue -->
		<linearGradient id="hotspot-in_construction" x1="0%" y1="0%" x2="0%" y2="100%">
			<stop offset="0%" stop-color="rgba(59, 130, 246, 0.5)" />
			<stop offset="100%" stop-color="rgba(59, 130, 246, 0.2)" />
		</linearGradient>
		<linearGradient id="hotspot-in_construction-hover" x1="0%" y1="0%" x2="0%" y2="100%">
			<stop offset="0%" stop-color="rgba(59, 130, 246, 0.7)" />
			<stop offset="100%" stop-color="rgba(59, 130, 246, 0.4)" />
		</linearGradient>
		<!-- Built: dark blue -->
		<linearGradient id="hotspot-built" x1="0%" y1="0%" x2="0%" y2="100%">
			<stop offset="0%" stop-color="rgba(30, 64, 175, 0.5)" />
			<stop offset="100%" stop-color="rgba(30, 64, 175, 0.2)" />
		</linearGradient>
		<linearGradient id="hotspot-built-hover" x1="0%" y1="0%" x2="0%" y2="100%">
			<stop offset="0%" stop-color="rgba(30, 64, 175, 0.7)" />
			<stop offset="100%" stop-color="rgba(30, 64, 175, 0.4)" />
		</linearGradient>
	</defs>
	{hotspots.map((immobile) => (
		<a href={`/immobili/${immobile.slug}`} data-title={immobile.data.title} data-status={immobile.data.status}>
			<polygon
				points={parseHotspot(immobile.data.hotspot!)}
				data-id={immobile.slug}
			/>
		</a>
	))}
</svg>

<style>
	.hotspots {
		position: absolute;
		inset: 0;
		width: 100%;
		height: 100%;
		pointer-events: none;
	}

	.hotspots a {
		pointer-events: auto;
	}

	.hotspots polygon {
		stroke: rgba(255, 255, 255, 0.5);
		stroke-width: 0.2;
		cursor: pointer;
		transition: all 0.2s;
	}

	.hotspots a[data-status="empty"] polygon { fill: url(#hotspot-empty); }
	.hotspots a[data-status="empty"]:hover polygon { fill: url(#hotspot-empty-hover); }
	.hotspots a[data-status="in_construction"] polygon { fill: url(#hotspot-in_construction); }
	.hotspots a[data-status="in_construction"]:hover polygon { fill: url(#hotspot-in_construction-hover); }
	.hotspots a[data-status="built"] polygon { fill: url(#hotspot-built); }
	.hotspots a[data-status="built"]:hover polygon { fill: url(#hotspot-built-hover); }

	.hotspots polygon:hover {
		stroke: rgba(255, 255, 255, 0.8);
		stroke-width: 0.3;
	}
</style>

<style is:global>
	.map-tooltip {
		position: fixed;
		background: white;
		color: var(--charcoal);
		padding: 0.5rem 0.75rem;
		font-size: var(--font-size-sm);
		border-radius: 4px;
		pointer-events: none;
		opacity: 0;
		transition: opacity 0.15s;
		z-index: 1000;
		box-shadow: 0 2px 8px rgba(0,0,0,0.15);
	}

	.map-tooltip.visible {
		opacity: 1;
	}
</style>

<script>
	const initHotspots = () => {
		let tooltip = document.getElementById('map-tooltip');
		if (!tooltip) {
			tooltip = document.createElement('div');
			tooltip.id = 'map-tooltip';
			tooltip.className = 'map-tooltip';
			document.body.appendChild(tooltip);
		}

		const polygons = document.querySelectorAll('.hotspots a');

		polygons.forEach((link) => {
			const title = link.getAttribute('data-title');

			link.addEventListener('mouseenter', () => {
				if (tooltip && title) {
					tooltip.textContent = title;
					tooltip.classList.add('visible');
				}
			});

			link.addEventListener('mousemove', (e) => {
				if (tooltip) {
					tooltip.style.left = `${(e as MouseEvent).clientX + 12}px`;
					tooltip.style.top = `${(e as MouseEvent).clientY + 12}px`;
				}
			});

			link.addEventListener('mouseleave', () => {
				if (tooltip) {
					tooltip.classList.remove('visible');
				}
			});
		});
	};

	document.addEventListener('astro:page-load', initHotspots);
</script>
