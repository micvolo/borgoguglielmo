---
import { ClientRouter } from 'astro:transitions';
import { Image } from 'astro:assets';
import Header from '../components/Header.astro';
import MapHotspots from '../components/MapHotspots.astro';
import mapSrc from '../assets/map.png';

interface Props {
	title: string;
}

const { title } = Astro.props;
---

<!doctype html>
<html lang="it">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>{title}</title>
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=Radley:ital@0;1&display=swap" rel="stylesheet">
		<ClientRouter />
	</head>
	<body>
		<Header />
		<main class="map-background">
			<div class="map-container">
				<div class="map-wrapper" id="map" transition:persist="map">
					<Image src={mapSrc} alt="Mappa Borgo Guglielmo" quality={80} format="webp" layout="full-width" />
					<MapHotspots />
				</div>
			</div>
		</main>
		<div class="card-overlay" transition:name="overlay">
			<aside class="card" transition:name="card">
				<a href="/" class="close" aria-label="Chiudi">
					<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
						<path d="M18 6L6 18M6 6l12 12"/>
					</svg>
				</a>
				<div class="card-content">
					<slot />
				</div>
			</aside>
		</div>
	</body>
</html>

<script>
	import Panzoom from '@panzoom/panzoom';

	const initMap = () => {
		const map = document.getElementById('map') as HTMLElement & { _panzoom?: ReturnType<typeof Panzoom> };
		const img = map?.querySelector('img') as HTMLImageElement | null;

		if (!map || !img) return;
		if (map._panzoom) return;

		const setup = () => {
			const imgW = img.naturalWidth;
			const imgH = img.naturalHeight;
			const winW = window.innerWidth;
			const winH = window.innerHeight;

			const defaultScale = 2.5;
			const savedJson = sessionStorage.getItem('mapState');
			const saved = savedJson ? JSON.parse(savedJson) : null;
			const scale = saved?.scale ?? defaultScale;
			const startX = saved?.x ?? (winW - imgW * defaultScale) / 2;
			const startY = saved?.y ?? (winH - imgH * defaultScale) / 2;

			const panzoom = Panzoom(map, {
				maxScale: 10,
				minScale: 1.5,
				startScale: scale,
				startX,
				startY,
				contain: 'outside',
			});

			map._panzoom = panzoom;

			const saveState = () => {
				const pan = panzoom.getPan();
				sessionStorage.setItem('mapState', JSON.stringify({ x: pan.x, y: pan.y, scale: panzoom.getScale() }));
			};

			map.addEventListener('panzoomstart', () => {
				map.classList.add('is-dragging');
			});

			map.addEventListener('panzoomend', () => {
				map.classList.remove('is-dragging');
				saveState();
			});

			let targetScale = scale;
			let currentScale = scale;
			let isAnimating = false;

			const lerp = (start: number, end: number, t: number) => start + (end - start) * t;

			const animateZoom = () => {
				currentScale = lerp(currentScale, targetScale, 0.04);

				if (Math.abs(currentScale - targetScale) > 0.001) {
					panzoom.zoom(currentScale, { animate: false });
					requestAnimationFrame(animateZoom);
				} else {
					currentScale = targetScale;
					panzoom.zoom(targetScale, { animate: false });
					isAnimating = false;
					saveState();
				}
			};

			map.parentElement?.addEventListener('wheel', (e) => {
				e.preventDefault();
				const delta = e.deltaY > 0 ? 0.95 : 1.05;
				targetScale = Math.min(10, Math.max(1.5, targetScale * delta));

				if (!isAnimating) {
					isAnimating = true;
					requestAnimationFrame(animateZoom);
				}
			}, { passive: false });
		};

		if (img.complete) {
			setup();
		} else {
			img.onload = setup;
		}
	};

	document.addEventListener('astro:page-load', initMap);
</script>

<style is:global>
	@import '../styles/global.css';

	@keyframes slideIn {
		from {
			transform: translateX(100%);
		}
		to {
			transform: translateX(0);
		}
	}

	@keyframes slideOut {
		from {
			transform: translateX(0);
		}
		to {
			transform: translateX(100%);
		}
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
		}
		to {
			opacity: 1;
		}
	}

	@keyframes fadeOut {
		from {
			opacity: 1;
		}
		to {
			opacity: 0;
		}
	}

	::view-transition-old(card) {
		animation: slideOut 300ms ease-in forwards;
	}

	::view-transition-new(card) {
		animation: slideIn 300ms ease-out forwards;
	}

	::view-transition-old(overlay) {
		animation: fadeOut 300ms ease-out forwards;
	}

	::view-transition-new(overlay) {
		animation: fadeIn 300ms ease-out forwards;
	}
</style>

<style>
	.map-background {
		position: fixed;
		inset: 0;
		overflow: hidden;
	}

	.map-container {
		position: absolute;
		inset: 0;
	}

	.map-wrapper {
		width: 100%;
		height: 100%;
		cursor: default !important;
	}

	:global(.map-wrapper.is-dragging) {
		cursor: grabbing !important;
	}

	.map-wrapper img {
		width: 100%;
		height: 100%;
		object-fit: cover;
		pointer-events: none;
		user-select: none;
	}

	.card-overlay {
		position: fixed;
		inset: 2rem;
		left: auto;
		z-index: 100;
		display: flex;
		justify-content: flex-end;
		pointer-events: none;
	}

	.card {
		position: relative;
		width: 50%;
		max-width: 700px;
		height: 100%;
		background: var(--white);
		color: var(--charcoal);
		overflow-y: auto;
		pointer-events: auto;
		border-radius: 0.5rem;
		box-shadow: 0 0 3rem 1rem rgba(255, 255, 255, 0.9);
	}

	.close {
		position: absolute;
		top: 1rem;
		right: 1rem;
		z-index: 10;
		width: 40px;
		height: 40px;
		display: flex;
		align-items: center;
		justify-content: center;
		background: var(--sand);
		border-radius: 50%;
		color: var(--charcoal);
		transition: background 0.2s;
	}

	.close:hover {
		background: var(--cream);
	}

	.card-content {
		min-height: 100%;
	}

	@media (max-width: 768px) {
		.card-overlay {
			inset: 1rem;
			left: auto;
		}

		.card {
			width: 100%;
			max-width: none;
		}
	}
</style>
